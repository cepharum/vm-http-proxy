var DNS = require( "dns" );



var dnsCache = {};
var map6To4 = {};


module.exports.initializeAdressMap = function( objContainers ) {
	Object.keys( objContainers ).forEach( function( vmName ) {
		var info = objContainers[vmName];

		if ( info.ipv4.length > 0 && info.ipv6.length > 0 ) {
			var ipv4 = info.ipv4[0];

			info.ipv6.forEach( function( ipv6 ) {
				map6To4[ipv6] = ipv4;
			} );
		}
	} );
};

module.exports.nameToAddress = function( requestContext, hostname, fncCallback ) {
	if ( hostname in dnsCache ) {
		fncCallback( requestContext, dnsCache[hostname] );
	}
	else {
		DNS.resolve6( hostname, function( error, addresses ) {
			if ( error )
				return requestContext.renderException( { 
					status: 404, 
					title: "Unknown Hostname", 
					text: "Failed to resolve name of requested target host." 
					} );

			if ( !addresses.some( function( address ) {
				if ( address in map6To4 ) {
					dnsCache[hostname] = address = map6To4[address];

					fncCallback( requestContext, address );

					return true;
				}
			} ) )
				return requestContext.renderException( { 
					status: 404, 
					title: "Unknown Hostname", 
					text: "Requested target host does not exist."
					} );
		} );
	}
};